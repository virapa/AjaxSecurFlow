import pytest
from fastapi.testclient import TestClient
from backend.app.main import app
from backend.app.core.config import settings

client = TestClient(app)

def test_request_shield_normalization_bypass():
    """
    Test that encoded malicious paths are blocked by the Shield.
    """
    # Previously blocked wp-admin, but %77p-admin might have bypassed it
    encoded_paths = [
        "/%77p-admin",       # w -> %77
        "/%2e%2e/auth/",     # .. -> %2e%2e
        "/%2f%2e%2e%2fauth/" # /../ -> %2f%2e%2e%2f
    ]
    
    for path in encoded_paths:
        response = client.get(path)
        assert response.status_code == 403
        assert "Malicious activity detected" in response.json()["detail"]

def test_ip_spoofing_protection_disabled_trust():
    """
    Test that X-Forwarded-For is ignored when TRUST_PROXIES is False.
    """
    # Ensure trust is disabled
    original_trust = settings.TRUST_PROXIES
    settings.TRUST_PROXIES = False
    
    try:
        # We use a real endpoint that logs IP or checking the utility directly
        # For simplicity in this test, we can check the get_client_ip utility
        from backend.app.core.security import get_client_ip
        from fastapi import Request
        
        # Mock request with X-Forwarded-For
        scope = {
            "type": "http",
            "headers": [(b"x-forwarded-for", b"1.1.1.1")],
            "client": ("127.0.0.1", 12345)
        }
        req = Request(scope=scope)
        
        ip = get_client_ip(req)
        assert ip == "127.0.0.1" # Should NOT be 1.1.1.1
        
    finally:
        settings.TRUST_PROXIES = original_trust

def test_ip_spoofing_protection_enabled_trust():
    """
    Test that X-Forwarded-For is respected when TRUST_PROXIES is True.
    """
    original_trust = settings.TRUST_PROXIES
    settings.TRUST_PROXIES = True
    
    try:
        from backend.app.core.security import get_client_ip
        from fastapi import Request
        
        # Mock request with X-Forwarded-For
        scope = {
            "type": "http",
            "headers": [(b"x-forwarded-for", b"1.2.3.4, 5.6.7.8")],
            "client": ("127.0.0.1", 12345)
        }
        req = Request(scope=scope)
        
        ip = get_client_ip(req)
        assert ip == "1.2.3.4" # Should take the first IP
        
    finally:
        settings.TRUST_PROXIES = original_trust
